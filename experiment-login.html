<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
      <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"></noscript>

<link rel="preload" href="experiment-css/experiment.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="experiment-css/experiment.css"></noscript>
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://kit.fontawesome.com/5c12c7df97.js" crossorigin="anonymous"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script type="text/javascript" src="experiment-js/experiment.js" defer></script>
  <title>17 legends</title>
  <link rel="icon" href="experiment-images/favicon.jpg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Agbalumo&family=Roboto&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="experiment-css/experiment.css" />
</head>

<body>
    <div class="custom-video-container">
        <video autoplay loop muted class="custom-background-video">
            <source src="videos/background.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    <div class="overlay"></div> 

    <script>
        // Function to check if a user is logged in
        function checkUserLoggedIn() {
            // Check if the userEmail is in localStorage (or use Firebase auth)
            const userEmail = localStorage.getItem("userEmail");
            if (userEmail) {
                // Redirect to index.html if logged in
                window.location.href = "index.html";
            }
        }
    
        // Call the function to check login status
        checkUserLoggedIn();
    </script>

  <div class="container">
    <style>
      .navbar-container {
          position: relative;
      }
      .navbar {
          background-color: rgba(169, 169, 169, 0.5);
          transition: background-color 0.3s ease;
      }
      .navbar.scrolled {
          background-color: rgba(0, 0, 0, 0.9);
      }
      .navbar-brand:hover,
      .navbar-nav .nav-link:hover {
          color: red;
      }
      .navbar-brand:visited,
      .navbar-nav .nav-link:visited {
          color: green;
      }
      .slide-left-view {
          opacity: 0;
          transform: translateX(-100%);
          transition: transform 1s ease, opacity 1s ease;
      }
      .slide-left-view.animated {
          opacity: 1;
          transform: translateX(0);
      }
      .slide-left-view:nth-child(1) {
          transition-delay: 0.1s;
      }
      .slide-left-view:nth-child(2) {
          transition-delay: 0.2s;
      }
      .slide-left-view:nth-child(3) {
          transition-delay: 0.3s;
      }
      .slide-left-view:nth-child(4) {
          transition-delay: 0.4s;
      }
      .slide-left-view:nth-child(5) {
          transition-delay: 0.5s;
      }
      .user-info-overlay {
          position: absolute;
          top: 100%;
          left: 50%;
          transform: translateX(-50%);
          background-color: #000;
          color: #fff;
          padding: 15px;
          border-radius: 5px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          z-index: 1;
          width: fit-content;
          opacity: 0;
          visibility: hidden;
          pointer-events: none;
          transition: transform 0.5s ease, opacity 0.5s ease;
      }
      .user-info-container.show-overlay .user-info-overlay {
          transform: translateX(-50%) translateY(10px);
          opacity: 1;
          visibility: visible;
          pointer-events: auto;
      }
      .slide-up-smartphone .user-info-overlay {
          transform: translateX(-50%) translateY(-100%);
          opacity: 1;
          visibility: visible;
      }
      .slide-down-pc .user-info-overlay {
          transform: translateX(-50%) translateY(10px);
          opacity: 1;
          visibility: visible;
      }
      .close-btn {
          position: absolute;
          top: -12px; /* Adjust this value to fine-tune the vertical position */
          right: 3px; /* Adjust this value to fine-tune the horizontal position */
          cursor: pointer;
          font-weight: bold;
          font-size: 1.5em;
          color: red;
      }
  </style>
  
      </head>
      <body>
      
        <div class="navbar-container">
            <nav class="navbar navbar-expand-lg navbar fixed-top">
                <div class="container-fluid">
                    <div class="logo-image slide-left-view">
                        <img src="experiment-images/favicon.jpg" class="img-fluid rounded">
                    </div>
                    <a class="navbar-brand slide-left-view" href="index.html">17 Legends</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="sidebar offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel" style="background-color: rgba(0, 0, 0, 0.4);">
                        <div class="offcanvas-header border-bottom">
                            <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Contents</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                        </div>
                        <div class="offcanvas-body d-flex flex-column flex-lg-row p-4 p-lg-0">
                            <ul class="navbar-nav justify-content align-items-center fs-5 flex-grow-1 pe-3">
                                <li class="nav-item mx-2 slide-left-view">
                                    <a class="nav-link" href="index.html">Home</a>
                                </li>
                                <li class="nav-item mx-2 slide-left-view">
                                    <a class="nav-link" href="1-index.html">About</a>
                                </li>
                            </ul>
                            <div class="d-flex flex-column flex-lg-row justify-content-center align-items-center gap-3">
                                <a href="experiment-login.html" class="text-green slide-left-view" id="login-link"><i class="fas fa-arrow-right-to-bracket"></i> Login</a>
                                <a href="experiment-signup.html" class="rounded-button slide-left-view" id="signup-link"><i class="far fa-user"></i> Sign Up</a>
                                <div class="user-info-container slide-left-view" id="user-info-container" style="display: none;">
                                    <a href="#" class="rounded-button" id="user-info-button"><i class="fas fa-user"></i> User Info</a>
                                    <div class="user-info-overlay">
                                        <span class="close-btn" id="close-btn">&times;</span>
                                        <p><strong>Username:</strong> <span id="username-display"></span></p>
                                        <p><strong>Email:</strong> <span id="email-display"></span></p>
                                    </div>
                                </div>
                                <a href="#" class="rounded-button slide-left-view" id="logout-link" style="display: none;"><i class="fas fa-arrow-right-from-bracket"></i> Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
      
      <script>
      document.addEventListener("DOMContentLoaded", function () {
          const navbar = document.querySelector(".navbar");
          const elementsToAnimate = document.querySelectorAll('.slide-left-view');
          const loginLink = document.getElementById("login-link");
          const signupLink = document.getElementById("signup-link");
          const logoutLink = document.getElementById("logout-link");
          const userInfoContainer = document.getElementById("user-info-container");
          const userInfoButton = document.getElementById("user-info-button");
          const usernameDisplay = document.getElementById("username-display");
          const emailDisplay = document.getElementById("email-display");
          const closeButton = document.getElementById("close-btn");
          const userInfoOverlay = document.querySelector(".user-info-overlay");
      
          // Check user login status
          function checkLoginStatus() {
              const userEmail = localStorage.getItem("userEmail");
              if (userEmail) {
                  const userName = userEmail.split("@")[0];
                  loginLink.style.display = "none";
                  signupLink.style.display = "none";
                  usernameDisplay.textContent = userName;
                  emailDisplay.textContent = userEmail;
                  userInfoContainer.style.display = "inline-block";
                  logoutLink.style.display = "inline-block";
              } else {
                  loginLink.style.display = "inline-block";
                  signupLink.style.display = "inline-block";
                  userInfoContainer.style.display = "none";
                  logoutLink.style.display = "none";
              }
          }
      
          logoutLink.addEventListener("click", function () {
              localStorage.removeItem("userEmail");
              localStorage.removeItem("popupShown"); // Optionally reset popupShown
      checkLoginStatus();
      window.location.href="index.html";
  });
      
          // Handle user info button click
          userInfoButton.addEventListener("click", function (event) {
              event.preventDefault();
              userInfoContainer.classList.toggle("show-overlay");
      
              // Toggle slide-up or slide-down animation based on device type
              if (isMobileDevice()) {
                  userInfoOverlay.style.transform = "translateX(-50%) translateY(-100%)";
              } else {
                  userInfoOverlay.style.transform = "translateX(-50%) translateY(10px)";
              }
      
              userInfoOverlay.style.opacity = 1;
              userInfoOverlay.style.visibility = "visible";
              userInfoOverlay.style.pointerEvents = "auto";
          });
      
          // Handle close button click
          closeButton.addEventListener("click", function () {
              userInfoOverlay.style.opacity = 0;
              userInfoOverlay.style.visibility = "hidden";
              userInfoOverlay.style.pointerEvents = "none";
          });
      
          // Function to detect mobile device
          function isMobileDevice() {
              return window.innerWidth <= 768;
          }
      
          // Run on page load
          checkLoginStatus();
      
          window.addEventListener("scroll", function () {
              if (window.scrollY > 50) {
                  navbar.classList.add("scrolled");
              } else {
                  navbar.classList.remove("scrolled");
              }
          });
      
          const observer = new IntersectionObserver((entries, observer) => {
              entries.forEach(entry => {
                  if (entry.isIntersecting) {
                      entry.target.classList.add('animated');
                      observer.unobserve(entry.target);
                  }
              });
          }, {
              threshold: 0.1
          });
      
          elementsToAnimate.forEach(element => {
              observer.observe(element);
          });
      });
      </script>
  <br><br><br>
    
  <div class="container d-flex justify-content-center align-items-center min-vh-100" style="background-color:  rgba(110, 110, 110, 0.685);">
    <div class="row border rounded-5 p-3 box-area" style="background-color: rgba(110, 110, 110, 0.685);">
      <div class="col-md-6 rounded-4 d-flex justify-content-center align-items-center flex-column left-box">
        <div class="featured-image">
                <img src="experiment-images/favicon.jpg" class="img-fluid rounded" alt="Loading..." style="width: 100%; height: 100%; object-fit: cover;">
        </div>
        <small class="text-wrap text-center" style="width: 17rem;"><br>Welcome Back</small>
      </div>
      <div class="col-md-6 right-box">
        <div class="row align-items-center">
          <div class="header-text mb-4">
            <h2>Hello, Again</h2>
            <div style="color: #fff;">We are happy to have you back.</div>
          </div>
          <div class="input-group mb-3">
            <input type="text" class="form-control form-control-lg bg-light fs-6" placeholder="Email Address" id="email">
          </div>
          <div class="input-group mb-1">
            <input type="password" class="form-control form-control-lg bg-light fs-6" placeholder="Password" id="password">
            <span class="input-group-text">
              <i class="fa-solid fa-eye" id="eye" onclick="toggle()"></i>
            </span>
          </div>
          </div>
          <script>
            var state = false;
            function toggle() {
              if (state) {
                document.getElementById("password").setAttribute("type", "password");
                document.getElementById("eye").style.color = '#7a797e';
                state = false;
              } else {
                document.getElementById("password").setAttribute("type", "text");
                document.getElementById("eye").style.color = '#5887ef';
                state = true;
              }
            }

          </script>
          <div class="input-group mb-5 d-flex justify-content-between">
            <div class="forgot">
              <small><a href="javascript:void(0)" id="forgotPasswordLink">Forgot Password?</a></small>
            </div>            
          </div>
          <div class="input-group mb-3">
            <button onclick="loginUser(event)" class="btn btn-lg btn-primary w-100 fs-6" id="login">Login</button>
          </div>
          <div style="text-align: center" id="or">
            <p>or</p>
          </div>
          <div class="input-group mb-3">
            <button onclick="loginWithGoogle(event)" class="btn btn-lg btn-light w-100 fs-6" id="google-signin"><img src="experiment-images/google.png" style="width: 20px" class="me-2" alt="Loading...">Sign In With Google</button>
          </div>
        </div>
      </div>
    </div>
  </div>
    
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content" style="background-color:  rgba(110, 110, 110, 0.685);">
            <div class="modal-header" style="background-color:  rgba(110, 110, 110, 0.685);">
              <h5 class="modal-title" id="forgotPasswordModalLabel" style="color: #fff;">Forgot Password</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background-color:  rgba(110, 110, 110, 0.685);">
              <div class="mb-3">
                <label for="modalResetEmail" class="form-label" style="color: #fff;">Email address</label>
                <input type="email" class="form-control form-control-lg bg-light fs-6" placeholder="Enter your email" id="modalResetEmail">
              </div>
            </div>
            <div class="modal-footer" style="background-color:  rgba(110, 110, 110, 0.685);">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="sendResetLink">Send Reset Link</button>
            </div>
          </div>
        </div>
      </div>  

      <script src="firebase-config.js"></script>
      <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
        import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app-check.js';
        import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js';
        import { getFirestore, collection, query, where, getDoc, getDocs, doc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);
        initializeAppCheck(app, {
  provider: new ReCaptchaV3Provider('6LdpeVYqAAAAAA2i5yEtBFiVV3cBS9WCAin8LK3w'),
  isTokenAutoRefreshEnabled: true
});

// âœ… SIMPLE FIRESTORE CLEANUP (This works!)
async function checkAndCleanExpiredUsers() {
    const user = auth.currentUser;
    
    if (user && !user.emailVerified) {
        const creationTime = user.metadata.creationTime;
        const accountAge = Date.now() - new Date(creationTime).getTime();
        const maxAge = 10 * 60 * 1000; // 10 minutes
        
        console.log(`â° Checking unverified user: ${Math.round(accountAge/1000)}s old`);
        
        if (accountAge > maxAge) {
            console.log('ðŸš¨ Cleaning up expired unverified user from Firestore');
            await performFirestoreCleanup(user);
        }
    }
}

// âœ… ONLY CLEARS FIRESTORE (No auth deletion attempts)
async function performFirestoreCleanup(user) {
    try {
        // Delete from Firestore users collection
        const userDocRef = doc(db, "users", user.uid);
        await deleteDoc(userDocRef).catch(() => {});
        console.log('ðŸ—‘ï¸ Removed user data from Firestore');
        
        // Delete from Firestore votes collection
        const voteDocRef = doc(db, "votes", user.uid);
        await deleteDoc(voteDocRef).catch(() => {});
        console.log('ðŸ—‘ï¸ Removed vote data from Firestore');
        
        // Sign out user
        await signOut(auth);
        console.log('ðŸ‘‹ Signed out user');
        
        // Clear localStorage
        localStorage.removeItem("userEmail");
        localStorage.removeItem("popupShown");
        
        // Show message and redirect
        alert('Please verify your email within 10 minutes. Your data has been cleared.');
        window.location.href = "index.html";
        
    } catch (error) {
        console.error('Error in Firestore cleanup:', error);
        // Still try to sign out
        await signOut(auth);
        window.location.href = "index.html";
    }
}

// âœ… START THE CLEANUP SYSTEM
// Run check when auth state changes
auth.onAuthStateChanged((user) => {
    if (user) {
        checkAndCleanExpiredUsers();
    }
});

// Run check periodically
setInterval(() => {
    if (auth.currentUser) {
        checkAndCleanExpiredUsers();
    }
}, 60 * 1000); // Check every minute

// Initial check after page load
setTimeout(() => {
    if (auth.currentUser) {
        checkAndCleanExpiredUsers();
    }
}, 3000);
    
        // Function to validate email format
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
    
async function loginUser(event) {
    event.preventDefault();

    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();

    if (email === "" || password === "") {
        alert("Please enter both email and password.");
        return;
    }

    if (!isValidEmail(email)) {
        alert("Please enter a valid email address.");
        return;
    }

    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // ðŸ”¹ Check sign-in method
        const provider = user.providerData[0]?.providerId;
        if (provider === "google.com") {
            alert("This account uses Google Sign-In. Please sign in with Google.");
            await signOut(auth);
            return;
        }

        // ðŸ”¹ Must verify email before login
        if (!user.emailVerified) {
            alert("Please verify your email before logging in.");
            await signOut(auth);
            return;
        }

        // ðŸ”¹ Load or create Firestore user doc
        const userDocRef = doc(db, "users", user.uid);
        const userSnapshot = await getDoc(userDocRef);

        if (!userSnapshot.exists()) {
            await setDoc(userDocRef, {
                email: user.email,
                userId: user.uid,
                emailVerified: true,
                signInMethod: "password",
                loginTime: Date.now()
            });
        }

        // ðŸ”¹ Save email and redirect
        localStorage.setItem("userEmail", user.email);
        window.location.href = "index.html";

    } catch (error) {
        console.error("Login error:", error);
        alert("Invalid email or password.");
    }
}


async function sendPasswordReset() {
    const email = document.getElementById("modalResetEmail").value.trim();

    if (!isValidEmail(email)) {
        alert("Please enter a valid email address.");
        return;
    }

    try {
        // 1ï¸âƒ£ Check Firestore for matching user
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("email", "==", email));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            // DO NOT reveal if email exists
            alert("If an account exists for this email, a password reset link has been sent.");
            return;
        }

        const userDoc = snapshot.docs[0].data();

        // 2ï¸âƒ£ BLOCK unverified users unless passwordResetAllowed = true
        if (!userDoc.emailVerified) {
            alert("Password reset is only available for verified accounts.");
            return;
        }

        // 3ï¸âƒ£ ALLOW RESET
        await sendPasswordResetEmail(auth, email);

        alert("If an account exists for this email, a password reset link has been sent.");
        $('#forgotPasswordModal').modal('hide');

    } catch (error) {
        console.error("Reset error:", error);
        alert("If an account exists for this email, a password reset link has been sent.");
    }
}


    
async function loginWithGoogle(event) {
    event.preventDefault();

    try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        localStorage.setItem("userEmail", user.email);

        const userDocRef = doc(db, "users", user.uid);
        const userSnapshot = await getDoc(userDocRef);

        if (!userSnapshot.exists()) {
            await setDoc(userDocRef, {
                email: user.email,
                userId: user.uid,
                emailVerified: true,
                signInMethod: "google",
                signupTime: Date.now()
            });
        }

        window.location.href = "index.html";

    } catch (error) {
        alert("Google sign-in failed: " + error.message);
    }
}

    
        // Periodic check for email verification
function checkEmailVerifiedPeriodically() {
    const user = auth.currentUser;
    
    if (!user) return;

    const intervalId = setInterval(async () => {
        try {
            await user.reload(); // Refresh user data
            if (user.emailVerified) {
                clearInterval(intervalId); // Stop the interval

                // Update Firestore to set emailVerified to true
                await setDoc(doc(db, "users", user.uid), { 
                    email: user.email, 
                    emailVerified: true 
                }, { merge: true });

                // Save email to local storage and redirect
                localStorage.setItem("userEmail", user.email);
                window.location.href = "index.html";
            }
        } catch (error) {
            console.error("Error checking email verification:", error);
            clearInterval(intervalId);
        }
    }, 3000); // Check every 3 seconds
}

// Automatically check for email verification
async function autoCheckEmailVerification() {
    const user = auth.currentUser;
    if (user) {
        try {
            await user.reload();
            if (!user.emailVerified) {
                console.log("User not verified, starting periodic check");
                checkEmailVerifiedPeriodically();
            } else {
                console.log("User already verified, redirecting");
                localStorage.setItem("userEmail", user.email);
                window.location.href = "index.html";
            }
        } catch (error) {
            console.error("Error in auto check:", error);
        }
    }
}

// Use Firebase auth state observer instead of DOMContentLoaded
auth.onAuthStateChanged((user) => {
    if (user && !user.emailVerified) {
        console.log("Auth state changed - unverified user detected");
        autoCheckEmailVerification();
    }
});
    
        // Wait for the DOM to load before attaching event listeners
        document.addEventListener("DOMContentLoaded", () => {
            autoCheckEmailVerification(); 
            document.getElementById('login').addEventListener("click", loginUser);
            document.getElementById('forgotPasswordLink').addEventListener("click", function () {
                $('#forgotPasswordModal').modal('show');
            });
            document.getElementById('sendResetLink').addEventListener("click", sendPasswordReset);
            document.getElementById('google-signin').addEventListener("click", loginWithGoogle);
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

</body>
</div>
</html>
